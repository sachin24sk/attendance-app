<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Ultra Dashboard</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Segoe UI;background:#eef2f7;padding:15px;margin:0;}
.topBar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
select,input,button{padding:8px;border-radius:6px;border:1px solid #ccc;}
table{width:100%;background:white;border-collapse:collapse;}
th{background:#1976d2;color:white;padding:8px;}
td{padding:8px;text-align:center;border-bottom:1px solid #eee;}
img{width:40px;height:40px;border-radius:50%;}
</style>
</head>

<body>

<h3>ğŸ“Š Ultra Attendance Dashboard</h3>

<div class="topBar">
<select id="subjectFilter"><option value="">All</option></select>
<input id="searchBox" placeholder="Search">
<button onclick="downloadExcel()">ğŸ“Š Excel</button>
<button onclick="downloadPDF()">ğŸ“„ PDF</button>
<button onclick="changePassword()">ğŸ” Change Password</button>
</div>

<table>
<thead>
<tr>
<th>Photo</th>
<th>Name</th>
<th>Subject</th>
<th>Date</th>
<th>Time</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<script>

const tableBody=document.getElementById("tableBody");
const subjectFilter=document.getElementById("subjectFilter");
const searchBox=document.getElementById("searchBox");

const params=new URLSearchParams(window.location.search);
let password=params.get("password")||"12345";

let allData=[];

/* LOAD DATA */
function loadAttendance(){
fetch("/api/admin/attendance?password="+password)
.then(r=>r.json())
.then(data=>{
allData=data;
fillDropdown(data);
applyFilters();
});
}

function fillDropdown(data){
subjectFilter.innerHTML='<option value="">All</option>';
[...new Set(data.map(d=>d.subject))].forEach(s=>{
const o=document.createElement("option");
o.value=s;
o.textContent=s;
subjectFilter.appendChild(o);
});
}

function renderTable(data){
tableBody.innerHTML="";
if(!data.length){
tableBody.innerHTML="<tr><td colspan='5'>No Attendance</td></tr>";
return;
}
data.forEach(a=>{
const row=document.createElement("tr");
row.innerHTML=`
<td><img src="${a.photo}"></td>
<td>${a.name}</td>
<td>${a.subject}</td>
<td>${a.date}</td>
<td>${a.time}</td>`;
tableBody.appendChild(row);
});
}

function applyFilters(){
let filtered=[...allData];
if(subjectFilter.value)
filtered=filtered.filter(d=>d.subject===subjectFilter.value);
if(searchBox.value)
filtered=filtered.filter(d=>d.name.toLowerCase().includes(searchBox.value.toLowerCase()));
renderTable(filtered);
}

subjectFilter.onchange=applyFilters;
searchBox.oninput=applyFilters;

/* â­ EXCEL DOWNLOAD */
function downloadExcel(){
let csv="Name,Subject,Date,Time\n";
allData.forEach(a=>{
csv+=`${a.name},${a.subject},${a.date},${a.time}\n`;
});
const blob=new Blob([csv],{type:"text/csv"});
const url=URL.createObjectURL(blob);
const a=document.createElement("a");
a.href=url;
a.download="attendance.csv";
a.click();
}

/* â­ PDF DOWNLOAD */
function downloadPDF(){
const {jsPDF}=window.jspdf;
const doc=new jsPDF();
let y=10;
doc.text("Attendance List",10,y);
y+=10;

allData.forEach(a=>{
doc.text(`${a.name} | ${a.subject} | ${a.date} | ${a.time}`,10,y);
y+=8;
});

doc.save("attendance.pdf");
}

/* â­ PASSWORD CHANGE */
function changePassword(){

const oldPass=prompt("Old Password:");
const newPass=prompt("New Password:");

fetch("/api/admin/change-password",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({oldPassword:oldPass,newPassword:newPass})
})
.then(r=>r.json())
.then(d=>alert(d.message));
}

setInterval(loadAttendance,8000);
loadAttendance();

</script>

</body>
</html>
