<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Smart Attendance</title>

<style>

body{
margin:0;
font-family:Segoe UI;
background:linear-gradient(135deg,#1976d2,#42a5f5);
display:flex;
justify-content:center;
align-items:center;
min-height:100vh;
padding:15px;
}

.card{
background:white;
width:100%;
max-width:360px;
border-radius:14px;
padding:18px;
box-shadow:0 10px 25px rgba(0,0,0,0.2);
text-align:center;
}

h2{
margin:5px 0;
color:#1976d2;
}

video{
width:100%;
border-radius:12px;
background:black;
}

#preview{
margin-top:10px;
width:100%;
border-radius:12px;
display:none;
}

.row{
display:flex;
gap:8px;
}

.row button{
flex:1;
}

input,button{
width:100%;
padding:12px;
margin-top:10px;
border-radius:8px;
font-size:15px;
}

button{
background:#1976d2;
color:white;
border:none;
font-weight:bold;
}

#status{
margin-top:10px;
white-space:pre-line;
color:#1976d2;
font-size:14px;
}

</style>
</head>

<body>

<div class="card">

<h2>ğŸ“ Smart Attendance</h2>
<h4 id="subjectTitle">Loading subject...</h4>

<input id="name" placeholder="Enter Your Name">

<video id="video" autoplay playsinline></video>

<!-- â­ SWITCH + CAPTURE SAME LINE -->
<div class="row">
<button onclick="switchCamera()">ğŸ”„ Switch</button>
<button onclick="capturePhoto()">ğŸ“¸ Capture</button>
</div>

<button id="retakeBtn" onclick="retakePhoto()" style="display:none;background:#f57c00;">
ğŸ” Recapture Photo
</button>

<img id="preview">

<canvas id="canvas" width="300" height="220" style="display:none"></canvas>

<button onclick="markAttendance()">âœ… Mark Attendance</button>

<div id="status"></div>

</div>

<script>

const video=document.getElementById("video");
const statusBox=document.getElementById("status");
const preview=document.getElementById("preview");
const retakeBtn=document.getElementById("retakeBtn");

let capturedPhoto="";
let currentCamera="environment";
let stream=null;

/* SUBJECT LOAD */

fetch("/api/current-subject")
.then(r=>r.json())
.then(d=>{
document.getElementById("subjectTitle").innerText=
"ğŸ“š "+d.subject+" | "+d.className;
})
.catch(()=>{
document.getElementById("subjectTitle").innerText="Subject not found";
});

/* CAMERA START */

function startCamera(){

navigator.mediaDevices.getUserMedia({
video:{facingMode:currentCamera}
})
.then(s=>{

if(stream){
stream.getTracks().forEach(track=>track.stop());
}

stream=s;
video.srcObject=stream;

})
.catch(()=>{
statusBox.innerText="Camera permission allow karo";
});

}

startCamera();

/* SWITCH CAMERA */

function switchCamera(){
currentCamera=(currentCamera==="environment")?"user":"environment";
startCamera();
}

/* CAPTURE PHOTO */

function capturePhoto(){

const canvas=document.getElementById("canvas");

canvas.getContext("2d").drawImage(video,0,0,300,220);

capturedPhoto=canvas.toDataURL("image/png");

/* CAMERA HIDE */
video.style.display="none";

if(stream){
stream.getTracks().forEach(track=>track.stop());
}

/* SHOW PREVIEW */
preview.src=capturedPhoto;
preview.style.display="block";

/* SHOW RETAKE BUTTON */
retakeBtn.style.display="block";

statusBox.innerText="Photo captured âœ”";

}

/* â­ RECAPTURE PHOTO */

function retakePhoto(){

preview.style.display="none";
video.style.display="block";
retakeBtn.style.display="none";

capturedPhoto="";

startCamera();

statusBox.innerText="Camera restarted";

}

/* MARK ATTENDANCE */

function markAttendance(){

const name=document.getElementById("name").value.trim();

if(!name){
statusBox.innerText="Name enter karo";
return;
}

if(!capturedPhoto){
statusBox.innerText="Photo capture karo";
return;
}

statusBox.innerText="Sending attendance...";

navigator.geolocation.getCurrentPosition(pos=>{

fetch("/api/attendance",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
name:name,
photo:capturedPhoto,
latitude:pos.coords.latitude,
longitude:pos.coords.longitude,
time:new Date().toLocaleTimeString()
})
})
.then(r=>r.json())
.then(d=>{
statusBox.innerText=
d.message+"\nSubject: "+d.subject+"\nDate: "+d.date;
});

},
()=>{
statusBox.innerText="Location allow karo";
},
{enableHighAccuracy:true});

}

</script>

</body>
</html>
