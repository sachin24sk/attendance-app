<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Smart Attendance</title>

<style>

body{
font-family:Segoe UI;
margin:0;
background:#eef2f7;
text-align:center;
padding:15px;
}

h2{
margin:10px 0;
}

video{
width:100%;
max-width:320px;
border-radius:12px;
background:black;
}

button,input{
width:100%;
max-width:320px;
padding:12px;
margin-top:10px;
border-radius:8px;
font-size:15px;
}

button{
background:#1976d2;
color:white;
border:none;
font-weight:bold;
}

#status{
margin-top:10px;
white-space:pre-line;
color:#1976d2;
}

</style>
</head>

<body>

<h2>ðŸŽ“ Smart Attendance</h2>

<h3 id="subjectTitle">Loading subject...</h3>

<input id="name" placeholder="Enter Your Name">

<video id="video" autoplay playsinline></video>

<button onclick="switchCamera()">ðŸ”„ Switch Camera</button>
<button onclick="capturePhoto()">ðŸ“¸ Capture Photo</button>

<canvas id="canvas" width="300" height="220" style="display:none"></canvas>

<button onclick="markAttendance()">âœ… Mark Attendance</button>

<div id="status"></div>

<script>

const video=document.getElementById("video");
const statusBox=document.getElementById("status");

let capturedPhoto="";
let currentCamera="environment";
let stream=null;

/* â­ LOAD SUBJECT */

fetch("/api/current-subject")
.then(r=>r.json())
.then(d=>{
document.getElementById("subjectTitle").innerText=
"ðŸ“š "+d.subject+" | "+d.className;
})
.catch(()=>{
document.getElementById("subjectTitle").innerText="Subject not found";
});

/* â­ START CAMERA */

function startCamera(){

navigator.mediaDevices.getUserMedia({
 video:{facingMode:currentCamera}
})
.then(s=>{

if(stream){
 stream.getTracks().forEach(track=>track.stop());
}

stream=s;
video.srcObject=stream;

})
.catch(()=>{
statusBox.innerText="Camera permission allow karo";
});

}

startCamera();

/* â­ SWITCH CAMERA */

function switchCamera(){

currentCamera=
(currentCamera==="environment")?"user":"environment";

startCamera();

}

/* â­ CAPTURE PHOTO */

function capturePhoto(){

const canvas=document.getElementById("canvas");

canvas.getContext("2d")
.drawImage(video,0,0,300,220);

capturedPhoto=canvas.toDataURL("image/png");

statusBox.innerText="Photo captured âœ”";

}

/* â­ MARK ATTENDANCE */

function markAttendance(){

const name=document.getElementById("name").value.trim();

if(!name){
statusBox.innerText="Name enter karo";
return;
}

if(!capturedPhoto){
statusBox.innerText="Photo capture karo";
return;
}

statusBox.innerText="Sending attendance...";

navigator.geolocation.getCurrentPosition(pos=>{

fetch("/api/attendance",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
 name:name,
 photo:capturedPhoto,
 latitude:pos.coords.latitude,
 longitude:pos.coords.longitude,
 time:new Date().toLocaleTimeString()
})
})
.then(r=>r.json())
.then(d=>{
statusBox.innerText=
d.message+"\nSubject: "+d.subject+"\nDate: "+d.date;
})
.catch(()=>{
statusBox.innerText="Server error";
});

},
()=>{
statusBox.innerText="Location allow karo";
},
{enableHighAccuracy:true});

}

</script>

</body>
</html>
